# 观察

本章讨论的是对透明物体的隐藏线和隐藏面的消除

# 7.1 绘制标准视体(C2S)

^d76a6e

目的：把物体的投影限制在标准视体内，即 x,y,z 都用 \[-1,1] 来定义

这一步实际上就是正交投影

先不考虑 z 值

一共进行两步操作：
1. 根据屏幕大小缩放(就是放大)
2. 将原点平移到中心

矩阵如下：

$\frac{n_x}2$ $0$ $\frac{n_x-1}2$
$0$   $\frac{n_y}2$ $\frac{n_y-1}2$
$0$    $0$     $1$

- 平移中的减 1 是为了保证变换到中心点
- 它是一个 C2S 变换(Clip to Screen)
- 原先(0,0)表示中点，变换后(0,0)为左下角

如果我们希望在变换后，(0,0) 为左上角(有些屏幕坐标系是这样的)，就用这个矩阵

$\frac{n_x}2$ $0$ $\frac{n_x-1}2$
$0$   $-\frac{n_y}2$ $\frac{n_y-1}2$
$0$    $0$     $1$

注意：我们认为像素坐标就是像素方格中间的哪个点

# 7.2 正射投影(V2C)

即 V2C(View to Clip)

转换前的立方体：正射投影视体
- 左裁剪面：$l$
- 右裁剪面：$r$
- 底部裁剪面：$b$
- 顶部裁剪面：$t$
- 近裁剪面：$n$
- 远裁剪面：$f$

且我们假设观察者沿着 $-z$ 方向观察，头指向 $+y$，右边为 $+x$
- 此时 $n>f$ ，$|n|<|f|$

操作步骤：
1. 平移至原点
 $$\begin{bmatrix}
1&0&0&-\frac{l+r}{2}\\
0&1&0&-\frac{b+t}{2}\\
0&0&1&-\frac{n+f}{2}\\
0&0&0&1
\end{bmatrix}$$
2. 缩放为标准立方体

$$\begin{bmatrix}
\frac{2}{r-l}&0&0&0\\
0&\frac{2}{t-b}&0&0\\
0&0&\frac{2}{n-f}&0\\
0&0&0&1
\end{bmatrix}$$ 
注意是先平移，再缩放 (W2C)

$$
\begin{bmatrix}
\frac{2}{r-l}&0&0&0\\
0&\frac{2}{t-b}&0&0\\
0&0&\frac{2}{n-f}&0\\
0&0&0&1
\end{bmatrix}
*
\begin{bmatrix}
1&0&0&-\frac{l+r}{2}\\
0&1&0&-\frac{b+t}{2}\\
0&0&1&-\frac{n+f}{2}\\
0&0&0&1
\end{bmatrix} 
$$

再回顾一下，前文的 [[#^d76a6e|C2S变换]] 。它是一个三维的，我们可以给它升一个维度

$$M_0 = 
\begin{bmatrix}
\frac{n_x}{2}&0&0&\frac{n_x-1}{2}\\
0&\frac{n_y}{2}&0&\frac{n_y-1}{2}\\
0&0&1&0\\
0&0&0&1
\end{bmatrix}
* 
\begin{bmatrix}
\frac{2}{r-l}&0&0&0\\
0&\frac{2}{t-b}&0&0\\
0&0&\frac{2}{n-f}&0\\
0&0&0&1
\end{bmatrix} 
*
\begin{bmatrix}
1&0&0&-\frac{l+r}{2}\\
0&1&0&-\frac{b+t}{2}\\
0&0&1&-\frac{n+f}{2}\\
0&0&0&1
\end{bmatrix}$$

我们之后通过 $M_0$ 矩阵，就可以直接将三维空间中的点转换为屏幕空间中的点了，然后找到对应的像素绘制即可

## 任意视点(W2V)

我们不一定局限于观察 $-z$ 方向，也可以是观察任意方向，只是将其转换到观察 $-z$ 方向即可

我们用这三个条件定义观察方向：
- 位置
- 朝向
- 向上方向

所以我们要做将其转换为观察 $-z$ 的标准方向上：
1. 平移位置到原点
2. 旋转朝向
3. 旋转向上方向
4. 然后取逆

因为我们实际上是应该把所有物体朝向观察点方向移动的，但是我们可以获取将观察点移动过来的矩阵，然后取逆
- 这就是协变->逆变
- 协变是移动点，逆变是移动坐标系

这个实际是 W2V

难点：怎么从给定的方向转化到标准的方向？

1. 罗德里格斯公式：我们可以用点积获取旋转角，用叉积获取旋转轴
$$R = Ecos\theta + (1-cos\theta)\begin{bmatrix}k_x\\k_y\\k_z\end{bmatrix}\begin{bmatrix}k_x&k_y&k_z\end{bmatrix}+sin\theta\begin{bmatrix}0&-k_z&k_y\\k_z&0&-k_x\\-k_y&k_x&0\end{bmatrix}$$ ^5183e5
- $R$：旋转矩阵
- $\theta$：旋转弧度
- $K$：旋转轴的单位向量
- $E$：单位向量

`W2V` 不知道怎么实现。。。只能暂时用 `glm::lookAt` 了

# 7.3 透视投影(V2C)

我们希望物体在屏幕上的大小和 $\frac{1}{z}$ 成正比，同时我们还希望用矩阵表示出来，这样方便计算

我们可以利用前面的正射投影矩阵来绘制透视图像，只需要在前面的矩阵前乘上一个系数即可(注意：此时 $z$ 值被变到什么位置都无所谓，因为它只有两个功能，一个是透视投影，即此处已被用过了，另一个是深度测试，即它们互相保持大小关系不变即可，数值可以发生变化)

它和正射投影的区别就是它的近平面和远平面不一样大，且所有透过眼睛的线都变换为平行线(注意：它们与近平面的交点没有变化)

齐次坐标：
- 第四维度表示其他三维的缩放程度
- 乘以它的矩阵：
	- 第四列的前三个表示 x,y,z 方向上的平移距离(当 w 为 1 时，否则要乘以 w 才表示平移距离)
	- 第四行的前三个表示 x,y,z 坐标对缩放的影响比例(最后一行只能有一个出现，不然就不线性了)，即这个比例乘上对应的坐标值，就是对整体的缩放系数的倒数

$$M_p=\begin{bmatrix}n&0&0&0\\0&n&0&0\\0&0&n+f&-nf\\0&0&1&0\end{bmatrix}$$

`glm::perspective(视角,宽高比,近平面,远平面)`

# 7.4 透视变换的性质

- 直线映射到直线
- 平面映射到平面
- 视体内的线段映射到标准视体中的线段

# 7.5 视域

隐含条件：
- x 方向对称
- y 方向对称
- 给出的视域宽高比等于屏幕的宽高比

即如果我们指定了 nx 和 ny，就只有一个自由度了(n，近平面距离)：此时可以用视域来定义
$$tan\frac{\theta}{2}=\frac{t}{|n|}$$