# 光线跟踪

之前的z缓冲器算法和BSP算法都是逐个图元进行处理的，而光线跟踪是逐个像素处理的。

光线追踪的好处：
1. 计算阴影比较简单
2. 计算反射比较简单

光栅化流程：
1. 深度测试，得到片元最靠近屏幕的物体
2. 通过Phong模型等设置该片元的颜色

光线跟踪：将这两步合二为一，即它技能找到合适的物体显示，又能设置颜色

# 10.1 基本的光线跟踪算法

如果我们仅仅希望它进行隐藏面消除的功能：
1. 从视点向像素发射一条射线
2. 找到和它相交的第一个物体即可

# 10.2 计算观察光线

操作应该是在 view 空间下进行的

我们定义一条直线：
- $e$：视点位置
- $s$：屏幕上一点
$$p(t)=e+t(s-e)$$

其中，$e$ 是给定的，找到 $s$ 是问题的关键：输入是像素坐标 i,j，输出是该像素位置
- $s_z$ ：我们已知是近平面 $n$
- $s_x=l+\frac{i+0.5}{n_x}(r-l)$
- $s_y=b+\frac{j+0.5}{n_y}(t-b)$

我们认为像素坐标是以左下角输入的，但是我们希望得到像素中点的坐标，且反馈到近可视平面上

所以通过它在屏幕空间中所占的百分比，代入到可视平面的插值式子，即可得到像素位置坐标

# 10.3 光线与物体相交

我们希望能找到 $t>0$ ，并且与之相交的第一个物体

光线方程：$p=e+td$

## 10.3.1 光线与球相交

球的方程：$f(p)=0$，即 $f(e+td)=0$

设圆心为 $c=(x_c,y_c,z_c)$，半径为 $R$ 则：
$$(x-x_c)^2+(y-y_c)^2+(z-z_c)^2-R^2=0$$

代入点：
$$(p-c)^2-R^2=0$$

然后求解即可

计算略

## 10.3.2 光线与三角形相交

光线与参数方程相交：t,u,v 是未知的
$$x_e+tx_d=f(u,v)$$
$$y_e+ty_d=g(u,v)$$
$$z_e+tz_d=h(u,v)$$

如果我们已知三角形的三个顶点 $a,b,c$，然后用它们来表示这个平面，则：
$$e+td=a+\beta(b-a)+\gamma(c-a)$$

当交点在三角形平面内时：
- $\beta>0$
- $\gamma$>0
- $\beta+\gamma<1$

计算略

## 10.3.3 光线与多边形相交

已知多边形有 m 个顶点分别为 p1~pm，表面法线为 n：
1. 计算光线与平面的交点
$$(p-p1)·n=0$$
2. 判断交点是否在多边形内
	- 最简单的方法：从 $p$ 点发射出任意一条二维光线，如果与多边形有交点且交点个数为奇数，则在内部，否则在外部
	- 或者参考光栅化思想：计算每条边和这个点的叉积，如果符号都相同就在内部，否则在外部

# 10.4 光线跟踪程序

在实际的应用中，可能需要返回被射中物体的引用

# 10.5 阴影

当我们处理一个点时，如果这一点和光源的连线没有物体遮挡，那么它就没有阴影，否则就在阴影中

# 10.6 镜面反射

$$c=c+c_sraycolor(p+sr,\varepsilon,∞)$$
- $c$：镜面反射颜色
- $c_s$：镜面反射系数

它会递归的调用下去，我们可以设置一个最大递归深度来修正这个问题

# 10.7 折射

电介质：另一种镜面物体

当折射率 $n$ 到折射率为 $n_t$ 的媒介时，会发生折射：
- $\theta$：入射光夹角
- $\phi$：折射光夹角
$$nsin\theta=n_tsin\phi$$

对应的余弦式子：余弦更好计算
$$cos^2\phi=1-\frac{n^2(1-cos^2\theta)}{n_t^2}$$

我们已平面 $n$ 和发生折射的法线 $b$ 建立正交基，设折射光线为 $t$，则：
$$t=sin\phi b-cos\phi n$$

再用这个描述再次发生折射出来时的光线 $d$，则：
$$d=sin\theta b-cos\theta n$$

但是 $d$ 和 $n$ 是已知的，$d$ 和入射光线相同，$n$ 是入射光线向平面的投影，此时可以求解 $b$：
$$b=\frac{d+ncos\theta}{sin\theta}$$

再由这个 $b$ 向上代入，可以求解 $t$ 了；计算略

当 $t$ 无法计算时，就说明没有折射光线，即所有能量都被反射了：完全内部反射
- 这就是玻璃

## 菲涅尔效果

菲涅尔公式：电介质的折射率随着折射角度而变化

我们可以使用 Schlick 近似：
- $R(\theta)$：表面的反射系数，即入射光被反射的比例
- $R_0$：法线上的反射系数，即垂直入射光的反射比例
	$$R_0=(\frac{n_t-1}{n_t+1})^2$$
- $\theta$：入射角度(通常是相对于法线的)
$$R(\theta)=R_0+(1-R_0)(1-cos\theta)^5$$

## Beer 效果

Beer定律：对于杂质分布均匀的物体，如：玻璃。透过的光线的强度将被降低。

当光线穿过介质时，它的强度降低：
- $dI$：光线的降低量
- $C$：表示光线在介质中的衰减程度
- $I$：光线的强度
- $dx$：光线的传播距离
$$dI=-CIdx$$

中间计算略

最终公式：
- $I(s)$：距离表面 $s$ 处的光线强度
- $a$：RGB降低常数
$$I(s)=I(0)e^{-ln(a)s}$$

假设所有物体初始都包含在空气中，折射率接近 1

# 10.8 实例化

图形学中的实例化：通过复制和变换矩阵来绘制多个相同或类似物体的技术，可以有效减少渲染计算和内存开销，提高图形渲染性能

实例化的基本思想：在物体被显示之前用变换矩阵对物体所有的点进行变形

即有一个简单物体 A，它经过一系列变换成了复杂物体 B。当我们希望和物体 B 求交时，可以把射线逆变换，然后和 A 求交，得到的结果再变换回去即可

优势：
1. 简单物体 A 的求交过程比复杂物体 B 简单
2. 许多变换后的物体可以和未变换的物体共享数据，这样可以减少存储

# 10.9 次线性的光线与物体相交

在前面的光线和物体的相交过程中，是对所有物体进行循环相交检测的。我们希望在预处理时就创建一个有序的数据结构，光线与物体相交时就可以用"分治法"在次线性时间内计算
- 分治法：将问题分解为小问题，然后逐个击破
- 次线性时间：时间复杂度小于线性的时间复杂度 $O(n)$

相当于是加速处理

## 10.9.1 包围盒

它不需要知道光线与包围盒相交的位置，只需要知道是否相交

先在二维空间来看：
1. 定义四条直线
	- $x=x_{min}$
	- $y=y_{min}$
	- $x=x_{max}$
	- $y=y_{max}$
2. 计算光线与这四条线相交时的 $t$，如 $t_{xmin}$：
$$t_{xmin}=\frac{x_{min}-x_e}{x_d}$$

3. 判断 $[t_{xmin},t_{xmax}] \bigcap [t_{ymin}, t_{ymax}]$ 是否存在

## 10.9.2 层次包围盒

基本思想：通过普通策略把一个轴向三维包围盒放在所有物体的外面

判断光线不与包围盒相交的检测代价要比蛮力搜索小

可以建立包围盒层次结构

一个包围盒保证包含的层次结构中所有在它下方的物体，但不保证包含所有在空间上相互重叠的物体

# 10.9.3 均匀空间子分法

这种方法是划分空间
- 空间中的一点可能同时在两个空间中

# 10.9.4 二叉空间划分法

我们也可以采用层次数据结构划分空间，如：二叉空间划分树

# 10.10 构造实体几何

构造实体几何(CSG)的基本思想：用集合运算合成实体形状

# 10.11 分布式光线追踪

直接光线追踪可能得到的图像太整洁了，用分布式光线追踪可以降低这种效果

## 10.11.1 反走样

1. 规则采样：在像素内规则增加采样点
2. 随机采样：在像素内随机增加采样点
3. 分层采样：即一个像素内分好多块，每个块内随机采样

## 10.11.2 软阴影

- 本影：完全不可见
- 半影：部分可见
- 非阴影区：完全可见

关键：把光源作为一个区域而不是一个点

一些方法：
1. 即可以把光源近似为 N 个点光源的集合，每个点光源的强度是基本光源的 $\frac{1}{N}$
2. 把光源区域视为有无穷多的光源，并随机为每一条观察光线选择一个光源

## 10.11.3 景深

景深：在面积非零的透镜上收集光线，而不是在一点上，这称为景深

## 10.11.4 光泽反射

某些表面，一定程度上介于理想镜面和漫反射表面之间，反射图像中某些是可辩别的，但是变模糊了

我们可以对理想镜面反射光线进行扰动来模拟这种现象

## 10.11.5 运动模糊

运动模糊：在物体上添加模糊的效果


