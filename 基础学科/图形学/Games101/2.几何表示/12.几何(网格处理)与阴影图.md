# 几何处理

## 网格细分

越多越平滑，有更多细节

之前的位移贴图，就是一个网格细分

细分：
1. 拆分为更多的三角形
2. 让三角形的位置发生一些变化，从而使原先的模型更加光滑一些

### Loop Subdivision

它和循环没有关系，是因为发明算法的人名字中有 Loop

1. 拆分：取三个边的中点，然后连接。就将一个三角形拆分为了 4 个三角形
2. 调整位置(顶点)：
	1. 区分新顶点和老顶点：新顶点就是之前三角形中不存在的顶点
	2. 新顶点(都是在边上的)：我们假设它所在的那条边由两个三角形(老)共享
		- 我们定义，共享这条边上的两个顶点是 A,B
		- 然后两个三角形除了 A,B 剩下的两个顶点为 C,D
		- 更新这个新顶点：$\frac{3}{8}(A+B)+\frac{1}{8}(C+D)$
	3. 旧顶点：设这个老顶点为 V，周围的所有顶点的和为 V_sum(不包含自己)
		- 首先，定义这个顶点的度 n，即它连接了几条边
		- 然后，再定义一个和度有关的数 u
			- $u=\frac{1}{n}(\frac{5}{8}-(\frac{3}{8}+\frac{1}{4}cos\frac{2\pi}{n})^2)$
		- 更新：$(1-n*u)*V + u*V_{sum}$

### Catmull-Clark Subdivision

Loop 细分的前提：必须本来就是三角网格了，才能使用这个算法

而 Catmull-Clark 细分可以表示任意网格的细分，且细分为四边形网格

提前定义几个概念：
- 四边形面
- 非四边形面
- 奇异点：度不为 4 的点

做法：
1. 拆分：每个边取中点，每个面取中点，然后连接
2. 调整位置：设老的点是 v，面中间的点是 f，边中间的点是 e
	1. 点在面中间的点：$\frac{v_1+v_2+v_3+v_4}{4}$
	2. 点在边的中间的点：$\frac{v_1+v_2+f_1+f_2}{4}$
	3. 老的点(自身是p点)：$\frac{f_1+f_2+f_3+f_4+2(m_1+m_2+m_3+m_4)+4p}{16}$

性质：
1. 只要原先的面不是四边形面，在中间添加的点就是奇异点
2. 但是每个非四边形面，都会被拆分为四边形面。就好像这些四边形面转化为了奇异点一样
3. 即只有当第一次做拆分的时候，会引入非四边形面个奇异点，但是之后的再次细分就不会引入新的奇异点了

## 网格简化

去掉一些三角形，同时保证他们的连接关系。为了提高程序的性能。

### 边坍缩

边坍缩(edge collapsing)：即一条边，捏成一个点的过程

但是有一个问题：哪些边需要坍缩？坍缩到哪里？

二次误差度量：即一个点到它所连接的面的距离的平方和最小

即我们可以计算每条边的二次度量误差，选择最小的坍缩(自然也就确定位置了)

操作：
1. 对所有边计算二次度量误差
2. 选择最小的进行边坍缩
3. 更新这次坍缩所影响的边的二次度量误差

## 网格正则化

## 阴影图

光栅化会遇到一些问题：设计到全局的光线传输以及阴影，都是比较困难的事情

着色：是一种局部的应用，它不考虑其他物体对其造成的影响。即如果有物体在它和光源之间，着色还是无法知道的，还是正常会着色。但是现实过程中是会产生阴影的。

Shadow Mapping：是一种图像空间的做法，即在生成阴影的这一步，是无需知道场景中的几何信息的(它会产生走样现象)

阴影图的思想：当不产生阴影时
1. 它可以被摄像机看到
2. 它可以被光源看到

注意：Shadow Mapping 只能处理点光源，即会有非常明显的阴影边界，即硬阴影

步骤：
1. 以光源为视点，对整个场景做一个光栅化，即得到光源可以看到的内容。这一步我们不需要做着色，只需要把对应的深度记录下来即可(同时会在顶点存储纹理坐标，用于第二步光栅化时的深度对比)
2. 以真正的摄像机开始，对整个场景做一个光栅化。然后对每一个光栅化的点，我们可以比较它和光源的距离以及在第一次光栅化中记录的深度。当距离和记录的深度相同时，就说明可以被看到。当距离和深度不相同时，说明这一个点不在光源的直射光范围内，就需要产生阴影了。

阴影图的分辨率，浮点数的精度等会影响效果

物理上的区分阴影：
- 本影：完全看不到光源
- 半影：部分看到光源

正常来说，点光源一定形不成软阴影的，因为软阴影是因为光源有大小导致的，即本影到完全没有阴影的半影这个过程，取决于看到的光源的大小。