# 光线追踪和光栅化

光栅化不好做全局的效果：
- 软阴影
- Glossy Reflection
- 间接光照

光线追踪：
- 准确，但是非常慢

# 基础的光线追踪

我们对光线的假设：
1. 光线沿直线传播
2. 光线和光线不会发生碰撞
3. 光线是从光源出发，最终到达我们的眼睛
	- 同时光线具有可逆性
	- 即同时也可以看作是我们眼睛发射光线，最终到达光源的一个过程

基本步骤：
1. 从视点出发，向每一个像素都发射光线
2. 计算这个光线和第一个物体的相交
3. 当相交后，和光源进行连线，判断是否可以发射到光源
	- 如果可以，就开始正常着色
	- 如果不可以，说明是阴影
4. 然后光线反射，进行能量衰减，然后继续判断(考虑完美的反射和折射)
5. 然后将所有点的着色结果相加，写到像素中即可

# 光线追踪中的技术问题

## 光线平面求交点

光线的定义：
- 设原点是 $o$
- 设方向是 $d$
- 光线的表示：
	- $0<=t<∞$
$$r(t)=o+td$$

球的定义：
$$(p-c)^2-R^2=0$$
- $p$：球面上任意一个点
- $c$：球心点
- $R$：半径

推广到一般的隐式函数：$f(p)=0$
$$f(o+td)=0$$

如果光线和物体有奇数个交点，说明是从物体内部发射的，否则一定有偶数个交点(可能是 0)

推广的一般的显式函数(三角形面片)：
1. 简化做法：和一个模型的每个三角形面片都计算：非常慢
2. 即不相交就是 0 个交点，相交就是 1 个交点

计算方式：判断光线和三角形所在平面的交点，然后判断这个点是否在三角形内部
1. 平面的需要信息：一个法向量 N 和平面内的一个点 P'
2. 平面的定义：$(p-p')·N=0$

另一种计算方式(MT算法)：即用重心坐标描述
$$o+td=(1-b_1-b_2)p_0+b_1p_1+b_2p_2$$

$$\begin{bmatrix}t\\b_1\\b_2\end{bmatrix}=\frac{1}{S_1·E_1}\begin{bmatrix}S_2·E_2\\S_1·S\\S_2·d\end{bmatrix}$$
- $E_1=p_1-p_0$
- $E_2=p_2-p_0$
- $S=o-p_0$
- $S_1=d×E_2$
- $S_2=S×E_1$

然后判断：
- t>=0
- b1>=0
- b2>=0
- (1-b1-b2)>=0

## 光线和平面求交点的加速

针对和三角形面形成的物体的计算加速

如果用上述原始的方法，就非常慢，因为每次都要和整个场景的物体都计算

方法：包围盒
- 即用一个简单的形状将物体给包围起来
- 如果一个光线和包围盒都碰不到，就一定碰不到内部的物体了

三维空间中常用的包围盒：长方体
- 把它理解为三个对面形成的交集

更细致的定义这个包围盒：轴对齐包围盒(Axis-Aligned Bounding Box)
- 即它的面和坐标轴形成平面的平行

所以问题转化为了如何和 AABB 盒求交点？
- 对一对平面而言：我们可以得到光线进入和离开的点(我们可以得到 3 对点)
- 然后对齐求交集，即找进入时的时间的最大值，找出去时的时间的最小值即可
- 当进入的时间小于出去的时间，说明这段时间就在盒子内部；否则就和盒子无交点(注意：我们还要求离开的时间大于 0，否则这个盒子就是在光线的背面处)

如何求和平面的交点？利用 AABB 盒的性质
- 如我们求和 yz 的两个对面的交点，我们只需要取 x 值进行计算就可以了
- 即 $o_x+td_x=面_x$

如果不是 AABB 盒，我们只能正常用平面表示求：
- $(o+td-p')·N=0$
- $t=\frac{(p'-o)·N}{d·N}$

