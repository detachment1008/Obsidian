# 蒙特卡洛积分

它是为了解决一个定积分的问题的：$\int_a^bf(x)dx$

正常情况下，我们是先进行不定积分，然后代入值进行相减即可，但是假如这个函数非常复杂，以至于难以求出它的不定积分呢

黎曼积分：将整个区间均匀的拆分成 100 份，每一份我都用中间的 x，并找到对应的 y，然后用 x \* y 代替这个长方形的面积，然后将这 100 份求和就是整个区域的面积，即定积分

蒙特卡洛积分：它采用了一种随机采样的积分方式。它先在积分域内随机采样一个点，然后求出它对应的 y 值，然后用这个 y 值作为长方形的高，整个区域作为长方形的宽，然后用长方形的面积近似表示整个区域的值。然后我们随机采样多次，并重复上述过程，最后将所有的结果求平均，就是这个区域的定积分。

$$F_N=\frac{1}{N}\sum_{i=1}^{N}\frac{f(X_i)}{p(X_i)}$$
- $F_N$：蒙塔卡洛积分的结果
- $f$：被积分的函数表达式
- $p$：随机变量的概率密度函数

当概率密度函数是常数时，即随机变量是均匀的，它就是黎曼积分

$N$ 越大，得到的结果越准

# 路径追踪

Whitted-Style Ray Tracing：
1. 当光线打到了光滑的物体上，它会沿镜面方向反射或进行折射
2. 当光线打到了漫反射的物体上，这条光线就停了

但是，它做的并不是对的

先定义两种材质：
1. Mirror reflection：完全的镜面反射。可以映射出周围的物体
2. Glossy reflection：没有那么光滑的镜面反射。但是依旧有高光。

Whitted 的两个问题：
1. 它对于 Glossy 的物体依旧进行了完全镜面反射，这是不正确的
2. 它对于漫反射物体，光线就停住了，这是不正确的
	- 即没有 Color Bleeding 效果：一个物体的颜色流到另一个物体上去(漫反射)

所以我们需要正确的方式计算结果：即使用渲染方程
- 解积分
- 有它存在递归

解积分：蒙特卡洛积分

随机选一个方向，然后找它对应的值
$$\begin{align}L_o(p,\omega_o)=\int_{\Omega^+}L_i(p,\omega_i)f_r(p,\omega_i,\omega_o)(n·\omega_i)d\omega_i\\
\approx \frac{1}{N}\sum_{i=1}^{N}\frac{L_i(p,\omega_i)f_r(p,\omega_i,\omega_o)(n·\omega_i)}{p(\omega_i)}\end{align}$$

做法：即当我们选择对一个点 p 着色时，我们随机选择 N 个方向发射光线，如果这个方向打到了光源，我们就计算然后将结果记录(这是直接光照)，如果光线打到了一个物体上，我们就算以这个光线的方向为出射光的直接光照即可。

仍存在的问题：
1. 会发生光线爆炸的现象

解决办法：当我们对一个点进行着色时，我们只向随机的一个方向去采样

N = 1 就是路径追踪

2. 递归永远不会停

解决办法：俄罗斯轮盘赌

即左轮手枪弹容量是 6，如果向里面装 2 发子弹，那么打一枪生存的概率就是 $\frac{4}{6}=\frac{2}{3}$

即我们提前定义好一个概率，然后我们以这个概率向某个方向发射一条光线，得到的返回值再除以这个概率

这其实就是一个随机变量是 2 的一个期望
- $E=P*(\frac{L_o}{P}+(1-P)*0=L_o$

此时算法已经正确了，但是仍不高效

我们之前用的是均匀的 pdf 概率密度函数去采样的，这会造成很多光线的浪费。

解决办法：我们在光源上采样，同时在光源上进行蒙特卡洛积分。设光源的面积是 A，我们只需要知道 $d\omega$ 和 $dA$ 的关系即可

我们把 A 向立体角的球形投影即可，会得到一个面积
$$d\omega=\frac{dAcos\theta'}{||x'-x||^2}$$
- A：光源面积
- x'：光源上采样的那一点
- x：真正的采样那一点
- $\omega$：光源那一点向采样那一点的连线的方向
- $\theta'$：$\omega$ 方向和光源法向量方向之间的夹角

即渲染方程就可以重写了：
$$\begin{align}L_o(p,\omega_o)=\int_{\Omega^+}L_i(p,\omega_i)f_r(p,\omega_i,\omega_o)(n·\omega_i)d\omega_i\\
=\int_{A}L_i(p,\omega_i)f_r(p,\omega_i,\omega_o)\frac{cos\theta cos\theta'}{||x'-x||^2}dA\end{align}$$
- $\theta$：采样点向光源点连线方向和采样点法向量之间的夹角

即一个点的着色：
1. 来自光源的光线：对光源进行采样求解
2. 来自其他物体的能量：还用正常的方法来做

还有一个小问题：我们还需要判断光源是否能直接照射到采样点，即中间还有没有物体遮挡

即先发射一条光线，判断以下是否有物体遮挡

注意：路径追踪处理的是面光源，点光源不好处理
- 建议：在使用上，可以用一个面积非常小的面光源代替

注意：从现在开始，光线追踪就不是指的是 Whitted 风格的光线追踪了，它包括了还有很多各种各样的求解算法，包括但不仅仅有路径追踪

额外：
- 如何采样？：参见作业
- 如何选取 pdf？：重要性采样理论
- 如何保证随机数的质量？：low discrepancy sequences
- 可不可以把采样点和光源点采样结合？：可以！multiple imp. sampling
- 对像素中获得的所有颜色，为什么就简单的平均起来就可以了？：pixel reconstruction filter
- 计算的 radiance 如何转化为像素颜色？：伽马校正，曲线，颜色空间