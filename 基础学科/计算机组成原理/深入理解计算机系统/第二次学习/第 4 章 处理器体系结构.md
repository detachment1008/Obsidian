# 引言
---

指令集体系结构(Instruction-Set Architecture)：即 ISA，包含：
- 一个处理器支持的指令
- 指令的字节级编码

不同处理器生产厂商有不同的 ISA，它们互不相同；但是同一个厂商的处理器家族一般都保持着兼容

编译器需要了解的：(不关系指令编码是如何执行的，只知道它可以执行)
1. 允许哪些指令(汇编)
2. 这些指令是如何编码的(汇编和字节级编码的对应关系)

处理器设计者：必须建造出能够执行这些指令(编码后)的处理器

本章将研究如何已知的 ISA 是如何被执行的：看上去是顺序执行的(对于编译器来说)，但实际是流水线执行

本章的过程：
1. 先定义一个简单的指令集，作为处理器实现的运行实例
2. 提供一些数字硬件设计的背景
3. 介绍一种描述硬件系统的语言：HCL(Hardware Control Language)
4. 开始设计处理器了
	1. 先实现一个基于顺序操作的处理器
	2. 创建一个流水线化的处理器
5. 通过工具研究和测试处理器的设计

# 4.1 Y86-64 指令集体系结构
---

首先，定义一个指令集体系结构，包括：
1. 各种状态单元
2. 指令集
3. 编码
4. 编程规范
5. 异常事件处理

## 4.1.1 程序员可见的状态

程序员可见的状态：即指令可以读取或修改的部分
- 通用寄存器
- 条件寄存器
- 程序计数器
- 程序状态
- 内存

## 4.1.2 Y86-64 指令

给出了 Y86_64 的 ISA 中的各个指令和对应编码，它只包括 8 字节的整数操作，编码长度从 1 字节到 10 字节不等

## 4.1.3 指令编码

指令的编码第一个字节表明了指令的类型：
- 高 4 位：代码部分(表示指令类)
- 低 4 位：功能部分(表示指令类中的具体指令)

寄存器有一个标识符，用这个标识符去编码表示寄存器即可
- 因为处理器中有一个小的随机存储器，以寄存器 id 作为地址；所以通过它和寄存器 id 就可以找到对应的寄存器；

如果不需要寄存器，就可以将其设置为 0xF 即可，表示无寄存器

在 x86_64 中，分支跳转使用的是相对地址；在这里我们为了方便，就用绝对地址了；过程调用可能都是绝对地址吧

指令集的一个重要性质：字节编码必须具有唯一的解释
- 所以我们也需要知道代码序列的起始位值

## 4.1.4 Y86-64 异常

状态码 Stat，它有四种状态：
1. AOK：正常操作
2. HLT：遇到 halt 指令
3. ADR：遇到非法地址
4. INS：遇到非法指令

在 Y86-64 中，遇到异常时我们会让处理器简单的停止执行指令；但实际上处理器通常会调用一个 **异常处理程序** ，用来处理指定的某种异常

## 4.1.5 Y86-64 程序

和 X86-64 的一些区别：
1. 它的立即数不能直接用于运算；需要先放到寄存器
2. 在运算的时候，不能直接使用内存中的值；需要先放到寄存器

伪指令：告诉汇编器如何放置等信息

一个程序的内存信息：从小到大
1. 预指令(调用 `main` 函数)
2. 数据
3. 代码(`main` 函数开始)
4. 栈(起始地址很大，然后向小地址方向增长；增长太多就将代码覆盖了)

有一个指令集模拟器(YIS)，可以帮助模拟 Y86-64 的机器代码程序执行

## 4.1.6 一些 Y86-64 指令的详情

对于 `pushq %rsp` 和 `popq %rsp` 这两个指令可能会有歧义，这里 Y86-64 和 X86-64 使用相同的处理：
1. 对于 `pushq %rsp`：原本是先移动 `%rsp`，再压入；但实际上是先记录原先 `%rsp` 的值，然后移动 `%rsp`，再将原先记录的值压入；即对其他没有影响，对于 `%rsp` 压入的是当前的值
2. 对于 `popq %rsp`：很正常，即先将值出栈到 `%rsp`，然后 `%rsp` 再加。

# 4.2 逻辑设计和硬件控制语言 HCL
---

数字系统的三个组成部分：
1. 组合逻辑：用于对位进行操作
2. 存储器单元：用于存储位
3. 时钟信号：控制存储器单元更新

HCL：高级语言描述硬件电路

HDL：硬件描述语言，低级一些；Verilog 就是其中一种语言

我们拥有将 HCL 翻译为 Verilog 的工具！

## 4.2.1 逻辑门

上面说的数字系统的三大部分，计算，存储，时钟信号；逻辑门就是用于计算的

数字系统：主要用于操作数字信号的。计算机可以说就是一种数字系统。

逻辑门的三大运算：
1. 与
2. 或
3. 非

我们用 C 语言中的逻辑运算符表示它们，即：`&&` ，`||`，`!`

为什么不是位运算符呢，即：`&`，`|`，`~`；这是因为逻辑门的两个输入(或一个输入)都是只对单个位的数进行操作的，而不是整个字(一次读取的全部位)

对于逻辑门，一旦一个门的输入变化了，输出也会相应的变化(非常快)

## 4.2.2 组合电路和 HCL 布尔表达式

什么是组合电路？即逻辑门的组合

组合电路的组成限制：
1. 每个逻辑门的输入来源固定：
	1. 系统输入
	2. 存储单元
	3. 其他逻辑门的输出
2. 两个或多个逻辑门的输出不能连在一起，因为它们的结果不一定相同，可能会导致出现错误
3. 组合电路必须是无环的。即不能一个逻辑门的输入经过一系列变化又到了自身的输入，这样也会出现错误的。

多路复用器：一种特殊的组合电路，利用 `s` 可以选择信号：
```
bool out = (s && a) || (!s && b);
```

HCL 和 C 语言表达式的区别：
1. HCL 组合电路是持续计算的，而 C 语言是调用时才计算
2. HCL 只接受 0 或 1，而 C 语言接受任意整数
3. HCL 的逻辑门对所有输入相应变化(同时)，而 C 语言是一个一个的，即它拥有短路求值的特性

## 4.2.3 字级的组合电路和 HCL 整数表达式
