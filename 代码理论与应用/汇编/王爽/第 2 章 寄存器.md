# 引言

前一章说的总线，实际上是外部总线，即它在 CPU 外部。而 CPU 内部是通过内部总线相连的

CPU 的组成：
1. 运算器：信息处理
2. 寄存器：信息存储
3. 控制器：控制外部器件进行工作

内部总线将这三种器件相连

# 2.1 通用寄存器

我们介绍的是 8086 CPU，它所有的寄存器都是 16 位的。它也可以分为两个 8 位寄存器来使用(如：AX -> AH，AL)

# 2.2 字在寄存器中的存储

由上述可知，8086 CPU 一次可以处理两种尺寸的数据：
1. 字节
2. 字

# 2.3 几条汇编指令

8086 是 Intel CPU，即使用的也是 Intel 汇编。它主要用于 Windows 平台。

书写汇编代码时，大小写不区分，即指令和寄存器可以随意大小写

```
move ax,4E20H
add ax,1406H
```

# 2.4 物理地址

CPU 在访问存储器单元时，需要给出存储器单元的编号，即地址。它被称为物理地址。

CPU 通过地址总线送入存储器的，就是一个内存单元的物理地址。在 CPU 向地址总线上发出物理地址之前，会先在内部生成这个物理地址。不同 CPU 有不同的物理地址形成方式，这里只讨论 8086 CPU

# 2.5 16 位结构的 CPU

什么时 16 位 CPU：
1. 运算器一次最多处理 16 位数据
2. 一个寄存器，最多存储 16 位数据
3. 寄存器和运算器之间的通路是 16 位

# 2.6 8086 CPU 给出形成物理地址的方法

8086 CPU 的地址总线有 20 根，所以它一次可以传送 20 位地址，但是它的 CPU 又是 16 位的结构。

所以为了匹配地址总线的能力，CPU 在内部通过两个 16 位地址合成的方式来形成一个 20 位的地址。

当 8086 CPU 要读写内存时：
1. CPU 提供两个 16 位地址：段地址，偏移地址
2. 段地址和偏移地址通过内部总线，送入运算器的地址加法部件
3. 地址加法将两个 16 位的地址合成为一个 20 位的物理地址
4. 地址加法器通过内部总线，将 20 位的物理地址送上地址总线
5. 20 位的物理地址被地址总线传送到存储器

物理地址 = 段地址 \* 16 + 偏移地址

即段地址，左移 4 位，然后加上偏移地址

# 2.7 段地址  \* 16 + 偏移地址=物理地址的真正含义

本质含义：CPU 在访问内存时，用一个基础地址和一个相对基础地址的偏移地址相加，给出内存单元的物理地址

这个基础地址是 20 位的，但是最后 4 个一定时 0 。所以给出这个基础地址的高 16 位就可以了

# 2.8 段的概念

其实内存并没有分段，段的划分来自于 CPU。

段的长度最大是 64 KB，因为偏移地址的最大长度就是 64 KB（$2^{16} = 64 * 2^{10} = 64KB$）

当段的长度不是 64 KB 时，说明有很多段 + 偏移都可以到达指定的目标地址

# 2.9 段寄存器

每次处理几乎都需要和内存交互，所以有专门提供地址的寄存器：
1. CS
2. DS
3. SS
4. ES

# 2.10 CS 和 IP

CS 和 IP：指示了 CPU 要读取指令的地址

即 CS \* 16 + IP = 物理地址

读取一条指令后，IP 中的值自动增加，以使 CPU 可以读取下一条指令。根据读取指令的大小，IP 增加对应的长度

CS:IP 的工作流程(循环)：
1. 从 CS：IP 指向的存储器单元读取指令，将读取的指令放到指令缓冲器
2. IP = IP + 所取指令的长度，从而指向下一条指令
3. 执行指令

在 8086 CPU 被启动后，CS 和 IP 会有默认的值，即此时指向的存储器单元就是 8086 CPU 开机后执行的第一条指令

# 2.11 修改 CS、IP 的指令

mov 被称为传送指令，可以设置大部分寄存器的值，但是唯独不允许设置 CS、IP 的值。

只有转移指令可以被用来设置 CS、IP 的值，如：jmp

1. 同时修改 CS 和 IP
用法：jmp 段地址:偏移地址
```
jmp 2AE3:3
```

2. 只修改 IP
用法：jmp 寄存器。如果单独修改，只能用寄存器修改 IP 地址
```
jmp ax
```

# 2.12 代码段

我们在编程时，可以人为的将一组连续、起始地址为 16 的倍数的内存定义为一个段。

其实就是随便给一个数，如果把它当作是段地址，那么它一定是 16 的倍数，因为它要左移 4 位。低位的地址一定是偏移地址给出的。

即只有是 16 的倍数的地址，才可以被当作是段地址。

如果我们设置一个代码段，需要把它的首地址设置为 16 的倍数的地址。然后将 CS 设置为这个地址，然后 IP 设置为 0 即可

# 实验 1 查看 CPU 和内存，用机器指令和汇编指令编程

## 1.预备知识：Debug 的使用

### (1) 什么是 Debug

它是实模式程序的调试工具，通过它可以查看 CPU 各种寄存器中的内容，内存使用情况，并追踪机器码程序的运行

### (2) 我们用到的 Debug 功能

1. R：查看、改变 CPU 寄存器中的内容
2. D：查看内存中的内容
3. E：改写内存中的内容
4. U：将内存中的机器指令翻译为汇编指令
5. T：执行一条汇编指令
6. A：以汇编指令的格式在内存中写入一条机器指令

### (3) 进入 Debug

DOS：Disk Operatoing System，即磁盘操作系统，是微软推出的第一款商用操作系统